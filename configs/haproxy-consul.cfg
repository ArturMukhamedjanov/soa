global
    daemon
    maxconn 4096
    log 127.0.0.1 local0 info

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option forwardfor
    option httplog
    log global

frontend https_vehicle_frontend
    bind *:8445 ssl crt /etc/haproxy/cert.pem
    default_backend vehicle_servers

frontend https_shop_frontend
    bind *:8446 ssl crt /etc/haproxy/cert.pem
    default_backend shop_servers

frontend http_frontend
    bind *:8081
    redirect scheme https code 301 if !{ ssl_fc }

backend vehicle_servers
    balance roundrobin
    option httpchk GET /actuator/health
    server-template vehicle-instances 1-10 _vehicle-service._tcp.service.consul resolvers consul check inter 2000 rise 2 fall 3 ssl verify none

backend shop_servers
    balance roundrobin
    option httpchk GET /shop-service/actuator/health
    server wildfly_instance1 127.0.0.1:25402 check ssl verify none inter 1000 rise 2 fall 3
    server wildfly_instance2 127.0.0.1:25403 check ssl verify none inter 1000 rise 2 fall 3

resolvers consul
    nameserver consul 127.0.0.1:8600
    accepted_payload_size 8192
    hold valid 10s
    timeout retry 2s

listen stats
    bind *:1936
    stats enable
    stats uri /
    stats hide-version
    stats auth admin:password
    stats refresh 10s

